!function(a,b){"use strict";b.extend(b.fn,{concreteConversation:function(a){return this.each(function(){var c=b(this),e=c.data("concreteConversation");e||c.data("concreteConversation",e=new d(c,a))})}});var c={Confirm_remove_message:"Remove this message? Replies to it will not be removed.",Confirm_mark_as_spam:"Are you sure you want to flag this message as spam?",Warn_currently_editing:"Please complete or cancel the current message editing session before editing this message.",Unspecified_error_occurred:"An unspecified error occurred.",Error_deleting_message:"Something went wrong while deleting this message, please refresh and try again.",Error_flagging_message:"Something went wrong while flagging this message, please refresh and try again."};b.fn.concreteConversation.localize=function(a){b.extend(!0,c,a)};var d=function(a,b){this.publish("beforeInitializeConversation",{element:a,options:b}),this.init(a,b),this.publish("initializeConversation",{element:a,options:b})};d.fn=d.prototype={publish:function(a,b){b=b||{},b.ConcreteConversation=this,window.ConcreteEvent.publish(a,b)},init:function(a,c){var d=this;d.$element=a,d.options=b.extend({method:"ajax",paginate:!1,displayMode:"threaded",itemsPerPage:-1,activeUsers:[],uninitialized:!0,deleteMessageToken:null,addMessageToken:null,editMessageToken:null,flagMessageToken:null},c);var e=""!=d.options.addMessageToken?1:0,f=d.options.paginate?1:0,g=d.options.orderBy,h=d.options.enableOrdering,i=d.options.displayPostingForm,j=d.options.enableCommentRating,k=d.options.enableTopCommentReviews,l=d.options.displaySocialLinks,m=d.options.addMessageLabel?d.options.addMessageLabel:"",n=d.options.dateFormat,o=d.options.customDateFormat,p=d.options.blockAreaHandle,q=d.options.attachmentsEnabled,r=d.options.attachmentOverridesEnabled;"ajax"==d.options.method?b.post(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:d.options.cnvID,cID:d.options.cID,blockID:d.options.blockID,enablePosting:e,itemsPerPage:d.options.itemsPerPage,addMessageLabel:m,paginate:f,displayMode:d.options.displayMode,orderBy:g,enableOrdering:h,displayPostingForm:i,enableCommentRating:j,enableTopCommentReviews:k,displaySocialLinks:l,dateFormat:n,customDateFormat:o,blockAreaHandle:p,attachmentsEnabled:q,attachmentOverridesEnabled:r},function(a){var c=window.obj;window.obj=d,d.$element.empty().append(a);var e=window.location.hash.match(/^#cnv([0-9]+)Message[0-9]+$/);if(null!==e&&e[1]==d.options.cnvID){var f=b("a"+window.location.hash).offset();b("html, body").animate({scrollTop:f.top},800,"linear")}window.obj=c,d.attachBindings(),d.publish("conversationLoaded")}):(d.attachBindings(),d.finishSetup(),d.publish("conversationLoaded"))},mentionList:function(a,c,d){var e=this;if(c){if(e.dropdown.parent.css({top:c.y,left:c.x}),0==a.length)return e.dropdown.handle.dropdown("toggle"),e.dropdown.parent.remove(),e.dropdown.active=!1,void(e.dropdown.activeItem=-1);e.dropdown.list.empty(),a.slice(0,20).map(function(a){var c=b("<li/>"),f=b("<a/>").appendTo(c).text(a.getName());f.click(function(){ConcreteEvent.fire("ConversationMentionSelect",{obj:e,item:a},d)}),c.appendTo(e.dropdown.list)}),e.dropdown.active||(e.dropdown.active=!0,e.dropdown.activeItem=-1,e.dropdown.parent.appendTo(e.$element),e.dropdown.handle.dropdown("toggle")),e.dropdown.activeItem>=0&&e.dropdown.list.children().eq(e.dropdown.activeItem).addClass("active")}},attachSubscriptionBindings:function(){b("a[data-conversation-subscribe]").magnificPopup({type:"ajax",callbacks:{updateStatus:function(a){if("ready"==a.status){var c=b("form[data-conversation-form=subscribe]");b("button").on("click",c,function(a){a.preventDefault(),a.stopPropagation(),b.ajax({url:c.attr("action"),dataType:"json",success:function(a){a.subscribed?(b("[data-conversation-subscribe=subscribe]").hide(),b("[data-conversation-subscribe=unsubscribe]").show()):(b("[data-conversation-subscribe=unsubscribe]").hide(),b("[data-conversation-subscribe=subscribe]").show()),b.magnificPopup.close()}})})}},beforeOpen:function(){this.st.mainClass="mfp-zoom-in"}},closeOnContentClick:!0,midClick:!0})},attachBindings:function(){var a=this;a.$element.unbind(".cnv"),a.options.uninitialized&&(a.options.uninitialized=!1,ConcreteEvent.bind("ConversationMention",function(b,c){a.mentionList(c.items,c.coordinates||!1,c.bindTo||a.$element.get(0))},a.$element.get(0)),a.dropdown={},a.dropdown.parent=b("<div/>").css({position:"absolute",height:0,width:0}),a.dropdown.active=!1,a.dropdown.handle=b("<a/>").appendTo(a.dropdown.parent),a.dropdown.list=b("<ul/>").addClass("dropdown-menu").appendTo(a.dropdown.parent),a.dropdown.handle.dropdown(),ConcreteEvent.bind("ConversationTextareaKeydownUp",function(b){a.dropdown.activeItem==-1&&(a.dropdown.activeItem=a.dropdown.list.children().length),a.dropdown.activeItem-=1,a.dropdown.activeItem+=a.dropdown.list.children().length,a.dropdown.activeItem%=a.dropdown.list.children().length,a.dropdown.list.children().filter(".active").removeClass("active").end().eq(a.dropdown.activeItem).addClass("active")},a.$element.get(0)),ConcreteEvent.bind("ConversationTextareaKeydownDown",function(b){a.dropdown.activeItem+=1,a.dropdown.activeItem+=a.dropdown.list.children().length,a.dropdown.activeItem%=a.dropdown.list.children().length,a.dropdown.list.children().filter(".active").removeClass("active").end().eq(a.dropdown.activeItem).addClass("active")},a.$element.get(0)),ConcreteEvent.bind("ConversationTextareaKeydownEnter",function(b){a.dropdown.list.children().filter(".active").children("a").click()},a.$element.get(0)),ConcreteEvent.bind("ConversationPostError",function(a,c){var d=c.form,e=c.messages,f="";b.each(e,function(a,b){f+=b+"<br>"}),d.find("div.ccm-conversation-errors").html(f).show()}),ConcreteEvent.bind("ConversationSubmitForm",function(a,b){b.form.find("div.ccm-conversation-errors").hide()}));var d=a.options.paginate?1:0,e=""!=a.options.addMessageToken?1:0,f=a.options.addMessageLabel?a.options.addMessageLabel:"";a.$replyholder=a.$element.find("div.ccm-conversation-add-reply"),a.$newmessageform=a.$element.find("div.ccm-conversation-add-new-message form"),a.$deleteholder=a.$element.find("div.ccm-conversation-delete-message"),a.$attachmentdeleteholder=a.$element.find("div.ccm-conversation-delete-attachment"),a.$permalinkholder=a.$element.find("div.ccm-conversation-message-permalink"),a.$messagelist=a.$element.find("div.ccm-conversation-message-list"),a.$messagecnt=a.$element.find(".ccm-conversation-message-count"),a.$postbuttons=a.$element.find("[data-submit=conversation-message]"),a.$sortselect=a.$element.find("select[data-sort=conversation-message-list]"),a.$loadmore=a.$element.find("[data-load-page=conversation-message-list]"),a.$messages=a.$element.find(".ccm-conversation-messages"),a.$messagerating=a.$element.find("span.ccm-conversation-message-rating"),a.$element.on("click.cnv","[data-submit=conversation-message]",function(c){c.preventDefault(),a.submitForm(b(this))}),a.$element.on("click.cnv","[data-submit=update-conversation-message]",function(){return a.submitUpdateForm(b(this)),!1}),this.attachSubscriptionBindings();var g=1;a.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(c){c.preventDefault(),b(".ccm-conversation-attachment-container").each(function(){b(this).is(":visible")&&b(this).toggle()});var d=a.$replyholder.appendTo(b(this).closest("[data-conversation-message-id]"));return d.attr("data-form","conversation-reply").show(),d.find("[data-submit=conversation-message]").attr("data-post-parent-id",b(this).attr("data-post-parent-id")),d.attr("rel","new-reply"+g),g++,!1}),b(".ccm-conversation-attachment-container").hide(),b(".ccm-conversation-add-new-message .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(a){a.preventDefault(),b(".ccm-conversation-add-reply .ccm-conversation-attachment-container").is(":visible")&&b(".ccm-conversation-add-reply .ccm-conversation-attachment-container").toggle(),b(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").toggle()}),b(".ccm-conversation-add-reply .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(a){a.preventDefault(),b(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").is(":visible")&&b(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").toggle(),b(".ccm-conversation-add-reply .ccm-conversation-attachment-container").toggle()}),a.$element.on("click.cnv","a[data-submit=delete-conversation-message]",function(){var d=b(this);return a.$deletedialog=a.$deleteholder.clone(),a.$deletedialog.dialog?a.$deletedialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:a.$deleteholder.attr("data-dialog-title"),buttons:[{text:a.$deleteholder.attr("data-cancel-button-title"),class:"btn pull-left",click:function(){a.$deletedialog.dialog("close")}},{text:a.$deleteholder.attr("data-confirm-button-title"),class:"btn pull-right btn-danger",click:function(){a.deleteMessage(d.attr("data-conversation-message-id"))}}]}):window.confirm(c.Confirm_remove_message)&&a.deleteMessage(d.attr("data-conversation-message-id")),!1}),a.$element.on("click.cnv","a[data-submit=flag-conversation-message]",function(){var d=b(this);return window.confirm(c.Confirm_mark_as_spam)&&a.flagMessage(d.attr("data-conversation-message-id")),!1}),a.$element.on("click.cnv","a[data-load=edit-conversation-message]",function(){if(b(".ccm-conversation-edit-message").is(":visible"))return window.alert(c.Warn_currently_editing),!1;var d=b(this);a.editMessage(d.attr("data-conversation-message-id"))}),a.$element.on("change.cnv","select[data-sort=conversation-message-list]",function(){a.$messagelist.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:a.options.cnvID,task:"get_messages",cID:a.options.cID,blockID:a.options.blockID,enablePosting:e,displayMode:a.options.displayMode,itemsPerPage:a.options.itemsPerPage,paginate:d,addMessageLabel:f,orderBy:b(this).val(),enableOrdering:a.options.enableOrdering,displayPostingForm:a.options.displayPostingForm,enableCommentRating:a.options.enableCommentRating,enableTopCommentReviews:a.options.enableTopCommentReviews,displaySocialLinks:a.options.displaySocialLinks,dateFormat:a.options.dateFormat,customDateFormat:a.options.customDateFormat,blockAreaHandle:a.options.blockAreaHandle,attachmentsEnabled:a.options.attachmentsEnabled,attachmentOverridesEnabled:a.options.attachmentOverridesEnabled},function(c){a.$replyholder.appendTo(a.$element),b(".ccm-conversation-messages .dropdown-toggle").dropdown(),a.attachBindings()})}),a.$element.on("click.cnv",".image-popover-hover",function(){b.magnificPopup.open({items:{src:b(this).attr("data-full-image"),type:"image",verticalFit:!0}})}),a.$element.on("click.cnv","[data-load-page=conversation-message-list]",function(){var c=parseInt(a.$loadmore.attr("data-next-page")),d=parseInt(a.$loadmore.attr("data-total-pages")),g=a.$sortselect.length?a.$sortselect.val():a.options.orderBy,h={cnvID:a.options.cnvID,cID:a.options.cID,blockID:a.options.blockID,itemsPerPage:a.options.itemsPerPage,displayMode:a.options.displayMode,blockAreaHandle:a.options.blockAreaHandle,enablePosting:e,addMessageLabel:f,page:c,orderBy:g,enableCommentRating:a.options.enableCommentRating,enableTopCommentReviews:a.options.enableTopCommentReviews,displaySocialLinks:a.options.displaySocialLinks,dateFormat:a.options.dateFormat,customDateFormat:a.options.customDateFormat,attachmentsEnabled:a.options.attachmentsEnabled,attachmentOverridesEnabled:a.options.attachmentOverridesEnabled};b.ajax({type:"post",data:h,url:CCM_TOOLS_PATH+"/conversations/message_page",success:function(e){a.$messages.append(e),b(".ccm-conversation-messages .dropdown-toggle").dropdown(),c+1>d?a.$loadmore.hide():a.$loadmore.attr("data-next-page",c+1)}})}),a.$element.on("click.cnv",".conversation-rate-message",function(){var c=b(this).closest("[data-conversation-message-id]").attr("data-conversation-message-id"),d=b(this).attr("data-conversation-rating-type");a.$messagerating.load(CCM_TOOLS_PATH+"/conversations/rate");var e={cnvID:a.options.cnvID,cID:a.options.cID,blockID:a.options.blockID,cnvMessageID:c,cnvRatingTypeHandle:d};b.ajax({type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/rate",success:function(a){b('span[data-message-rating="'+c+'"]').load(CCM_TOOLS_PATH+"/conversations/get_rating",{cnvMessageID:c})}})}),a.$element.on("click.cnv","a.share-popup",function(){var a=void 0!=window.screenLeft?window.screenLeft:screen.left,c=void 0!=window.screenTop?window.screenTop:screen.top,d=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,e=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,f=d/2-300+a,g=e/2-125+c;return window.open(b(this).attr("href"),"cnvSocialShare","left:"+f+",top:"+g+",height=250,width=600,toolbar=no,status=no"),!1}),a.$element.on("click.cnv","a.share-permalink",function(){var c=b(this),d=c.attr("rel");a.$permalinkdialog=a.$permalinkholder.clone();var e=b("<textarea readonly>").text(decodeURIComponent(d));return a.$permalinkdialog.append(e),e.click(function(){var a=b(this);a.select(),window.setTimeout(function(){a.select()},1),a.mouseup(function(){return a.unbind("mouseup"),!1})}),a.$permalinkdialog.dialog&&a.$permalinkdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:a.$permalinkholder.attr("data-dialog-title"),buttons:[{text:a.$permalinkholder.attr("data-cancel-button-title"),class:"btn pull-left",click:function(){a.$permalinkdialog.dialog("close")}}]}),!1}),a.options.attachmentsEnabled>0&&a.$element.concreteConversationAttachments(a),b(".dropdown-toggle").dropdown()},handlePostError:function(a,b){b||(b=[c.Unspecified_error_occurred]),this.publish("conversationPostError",{form:a,messages:b})},deleteMessage:function(a){var d=this;d.publish("conversationBeforeDeleteMessage",{msgID:a});var e=[{name:"cnvMessageID",value:a},{name:"token",value:d.options.deleteMessageToken}];b.ajax({type:"post",data:e,dataType:"json",url:CCM_TOOLS_PATH+"/conversations/delete_message",success:function(e){if(e.error)window.alert(c.Error_deleting_message+"\n\n"+e.errors.join("\n"));else{var f=b("[data-conversation-message-id="+a+"]");f.length&&f.remove(),d.updateCount(),d.$deletedialog.dialog&&d.$deletedialog.dialog("close"),d.publish("conversationDeleteMessage",{msgID:a})}},error:function(b){d.publish("conversationDeleteMessageError",{msgID:a,error:arguments}),window.alert(c.Error_deleting_message)}})},editMessage:function(a){var c=this,d=[{name:"cnvMessageID",value:a},{name:"cID",value:this.options.cID},{name:"blockAreaHandle",value:this.options.blockAreaHandle},{name:"bID",value:this.options.blockID}];b.ajax({type:"post",data:d,url:CCM_TOOLS_PATH+"/conversations/edit_message",success:function(d){var e=b(".ccm-conversation-message[data-conversation-message-id="+a+"]"),f=e;e.after(d).remove(),b(".ccm-conversation-attachment-container").hide(),b(".ccm-conversation-edit-message .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(a){a.preventDefault(),b(".ccm-conversation-edit-message .ccm-conversation-attachment-container").toggle()}),c.$editMessageHolder=c.$element.find("div.ccm-conversation-edit-message"),c.$element.concreteConversationAttachments(c),b("button.cancel-update").on("click.cnv",function(){b(".ccm-conversation-edit-message").replaceWith(f)})},error:function(b){c.publish("conversationEditMessageError",{msgID:a,error:arguments})}})},flagMessage:function(a){var d=this;d.publish("conversationBeforeFlagMessage",{msgID:a});var e=[{name:"token",value:d.options.flagMessageToken},{name:"cnvMessageID",value:a}];b.ajax({type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/flag_message",success:function(c){var e=b(".ccm-conversation-message[data-conversation-message-id="+a+"]");e.length&&e.after(c).remove(),d.updateCount(),d.publish("conversationFlagMessage",{msgID:a})},error:function(b){d.publish("conversationFlagMessageError",{msgID:a,error:arguments}),window.alert(c.Error_flagging_message)}})},addMessageFromJSON:function(a,c){var d=this;d.publish("conversationBeforeAddMessageFromJSON",{json:c,form:a});var e=""!=d.options.addMessageToken?1:0,f=[{name:"cnvMessageID",value:c.cnvMessageID},{name:"enablePosting",value:e},{name:"displayMode",value:d.options.displayMode},{name:"enableCommentRating",value:d.options.enableCommentRating},{name:"displaySocialLinks",value:d.options.displaySocialLinks}];b.ajax({type:"post",data:f,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(e){var f=b(".ccm-conversation-message[data-conversation-message-id="+c.cnvMessageParentID+"]");if(f.length){f.after(e),d.$replyholder.appendTo(d.$element),d.$replyholder.hide(),d.$replyholder.find(".conversation-editor").val("");try{d.$replyholder.find(".redactor_conversation_editor_"+d.options.cnvID).redactor("set","")}catch(a){}}else{"date_desc"==d.options.orderBy?d.$messages.prepend(e):d.$messages.append(e),d.$element.find(".ccm-conversation-no-messages").hide(),d.$newmessageform.find(".conversation-editor").val("");try{d.$newmessageform.find(".redactor_conversation_editor_"+d.options.cnvID).redactor("set","")}catch(a){}}d.publish("conversationAddMessageFromJSON",{json:c,form:a}),d.updateCount();var g=b("a#cnv"+d.options.cnvID+"Message"+c.cnvMessageID).offset();b(".dropdown-toggle").dropdown(),b("html, body").animate({scrollTop:g.top},800,"linear")}})},updateMessageFromJSON:function(a,c){var d=this,e=""!=d.options.addMessageToken?1:0,f=[{name:"cnvMessageID",value:c.cnvMessageID},{name:"enablePosting",value:e},{name:"displayMode",value:d.options.displayMode},{name:"enableCommentRating",value:d.options.enableCommentRating},{name:"displaySocialLinks",value:d.options.displaySocialLinks}];b.ajax({type:"post",data:f,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(a){var d=b("[data-conversation-message-id="+c.cnvMessageID+"]");d.after(a).remove(),b(".dropdown-toggle").dropdown()}})},updateCount:function(){var a=this;a.publish("conversationBeforeUpdateCount"),a.$messagecnt.load(CCM_TOOLS_PATH+"/conversations/count_header",{cnvID:a.options.cnvID},function(){a.publish("conversationUpdateCount")})},submitForm:function(a){var c=this;c.publish("conversationBeforeSubmitForm");var d=a.closest("form");a.prop("disabled",!0),d.parent().addClass("ccm-conversation-form-submitted");var e=d.serializeArray(),f=a.attr("data-post-parent-id");e.push({name:"token",value:c.options.addMessageToken},{name:"cnvID",value:c.options.cnvID},{name:"cnvMessageParentID",value:f},{name:"enableRating",value:f}),b.ajax({dataType:"json",type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/add_message",success:function(a){return a?a.error?(c.handlePostError(d,a.errors),!1):(b(".preview.processing").each(function(){b('input[rel="'+b(this).attr("rel")+'"]').remove()}),b("form.dropzone").each(function(){var a=b(this).data("dropzone");b.each(a.files,function(b,c){a.removeFile(c)})}),c.addMessageFromJSON(d,a),void c.publish("conversationSubmitForm",{form:d,response:a})):(c.handlePostError(d),!1)},error:function(a){return c.handlePostError(d),!1},complete:function(b){a.prop("disabled",!1),d.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})},submitUpdateForm:function(a){var c=this;c.publish("conversationBeforeSubmitForm");var d=a.closest("form");a.prop("disabled",!0),d.parent().addClass("ccm-conversation-form-submitted");var e=d.serializeArray(),f=a.attr("data-post-message-id");e.push({name:"token",value:c.options.editMessageToken},{name:"cnvMessageID",value:f}),b.ajax({dataType:"json",type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/update_message",success:function(a){return a?a.error?(c.handlePostError(d,a.errors),!1):(b(".preview.processing").each(function(){b('input[rel="'+b(this).attr("rel")+'"]').remove()}),c.updateMessageFromJSON(d,a),void c.publish("conversationSubmitForm",{form:d,response:a})):(c.handlePostError(d),!1)},error:function(a){return c.handlePostError(d),!1},complete:function(b){a.prop("disabled",!1),d.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})},tool:{setCaretPosition:function(a,b){if(null!=a)if(a.createTextRange){var c=a.createTextRange();c.move("character",b),c.select()}else a.selectionStart?(a.focus(),a.setSelectionRange(b,b)):a.focus()},getCaretPosition:function(a){if(a.selectionStart)return a.selectionStart;if(document.selection){a.focus();var b=document.selection.createRange();if(null==b)return 0;var c=a.createTextRange(),d=c.duplicate();return c.moveToBookmark(b.getBookmark()),d.setEndPoint("EndToStart",c),d.text.length}return 0},testMentionString:function(a){return/^@[a-z0-9]+$/.test(a)},getMentionMatches:function(a,b){return b.filter(function(b){return b.indexOf(a)>=0})},isSameConversation:function(a,b){return a.options.blockID===b.options.blockID&&a.options.cnvID===b.options.cnvID},MentionUser:function(a){this.getName=function(){return a}}}}}(window,jQuery),function(a,b){"use strict";var c={Too_many_files:"Too many files",Invalid_file_extension:"Invalid file extension",Max_file_size_exceeded:"Max file size exceeded",Error_deleting_attachment:"Something went wrong while deleting this attachment, please refresh and try again.",Confirm_remove_attachment:"Remove this attachment?"},d={init:function(a){var d=a;return d.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(){b(".ccm-conversation-wrapper").concreteConversationAttachments("clearDropzoneQueues")}),d.$element.on("click.cnv","a.attachment-delete",function(a){a.preventDefault(),b(this).concreteConversationAttachments("attachmentDeleteTrigger",d)}),d.$editMessageHolder&&!d.$editMessageHolder.find(".dropzone").attr("data-dropzone-applied")&&d.$editMessageHolder.find(".dropzone").not('[data-drozpone-applied="true"]').dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(a,c){var e=this;b(a.previewTemplate).click(function(){e.removeFile(a),b('input[rel="'+b(this).attr("rel")+'"]').remove()});var f=JSON.parse(c);if(f.error){var g=b('.preview.processing[rel="'+f.timestamp+'"]').closest("form");d.handlePostError(g,[f.error]),b('.preview.processing[rel="'+f.timestamp+'"]').remove(),g.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){b(this).html("")})}else b(this.element).closest("div.ccm-conversation-edit-message").find("form.aux-reply-form").append('<input rel="'+f.timestamp+'" type="hidden" name="attachments[]" value="'+f.id+'" />')},accept:function(a,e){var f=[],g=this.files.length;d.options.maxFiles>0&&g>d.options.maxFiles&&f.push(c.Too_many_files);var h=d.options.fileExtensions.split(",");if(a.name.split(".").pop().toLowerCase()&&h.indexOf(a.name.split(".").pop().toLowerCase())==-1&&""!=h&&f.push(c.Invalid_file_extension),d.options.maxFileSize>0&&a.size>1e6*d.options.maxFileSize&&f.push(c.Max_file_size_exceeded),f.length>0){var i=this;b('input[rel="'+b(a.previewTemplate).attr("rel")+'"]').remove();var j=b(a.previewTemplate).parent(".dropzone");i.removeFile(a),d.handlePostError(j,f),j.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){b(this).html("")}),g=-1,e("error")}else e()},sending:function(a,c,e){b(a.previewTemplate).attr("rel",(new Date).getTime()),e.append("timestamp",b(a.previewTemplate).attr("rel")),e.append("tag",b(d.$editMessageHOlder).parent("div").attr("rel")),e.append("fileCount",b(d.$editMessageHolder).find('[name="attachments[]"]').length)},init:function(){b(this.element).data("dropzone",this)}}),d.$newmessageform.dropzone&&!b(d.$newmessageform).attr("data-dropzone-applied")&&(d.$newmessageform.dropzone({accept:function(a,e){var f=[],g=this.files.length;d.options.maxFiles>0&&g>d.options.maxFiles&&f.push(c.Too_many_files);var h=d.options.fileExtensions.split(",");if(a.name.split(".").pop().toLowerCase()&&h.indexOf(a.name.split(".").pop().toLowerCase())==-1&&""!=h&&f.push(c.Invalid_file_extension),d.options.maxFileSize>0&&a.size>1e6*d.options.maxFileSize&&f.push(c.Max_file_size_exceeded),f.length>0){var i=this;b('input[rel="'+b(a.previewTemplate).attr("rel")+'"]').remove();var j=b(a.previewTemplate).parent(".dropzone");i.removeFile(a),d.handlePostError(j,f),j.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){b(this).html("")}),g=-1,e("error")}else e()},url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(a,c){var e=this;b(a.previewTemplate).click(function(){b('input[rel="'+b(this).attr("rel")+'"]').remove(),e.removeFile(a)});var f=JSON.parse(c);if(f.error){var g=b('.preview.processing[rel="'+f.timestamp+'"]').closest("form");d.handlePostError(g,[f.error]),b('.preview.processing[rel="'+f.timestamp+'"]').remove(),g.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){b(this).html("")})}else b('div[rel="'+f.tag+'"] form.main-reply-form').append('<input rel="'+f.timestamp+'" type="hidden" name="attachments[]" value="'+f.id+'" />')},sending:function(a,c,e){b(a.previewTemplate).attr("rel",(new Date).getTime()),e.append("timestamp",b(a.previewTemplate).attr("rel")),e.append("tag",b(d.$newmessageform).parent("div").attr("rel")),e.append("fileCount",this.files.length)},init:function(){b(this.element).data("dropzone",this)}}),b(d.$newmessageform).attr("data-dropzone-applied","true")),b(d.$replyholder.find(".dropzone")).attr("data-dropzone-applied")||d.$replyholder.find(".dropzone").not('[data-drozpone-applied="true"]').dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(a,c){var e=this;b(a.previewTemplate).click(function(){e.removeFile(a),b('input[rel="'+b(this).attr("rel")+'"]').remove()});var f=JSON.parse(c);if(f.error){var g=b('.preview.processing[rel="'+f.timestamp+'"]').closest("form");d.handlePostError(g,[f.error]),b('.preview.processing[rel="'+f.timestamp+'"]').remove(),g.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){b(this).html("")})}else b(this.element).closest("div.ccm-conversation-add-reply").find("form.aux-reply-form").append('<input rel="'+f.timestamp+'" type="hidden" name="attachments[]" value="'+f.id+'" />')},accept:function(a,e){var f=[],g=this.files.length;d.options.maxFiles>0&&g>d.options.maxFiles&&f.push(c.Too_many_files);var h=d.options.fileExtensions.split(",");if(a.name.split(".").pop().toLowerCase()&&h.indexOf(a.name.split(".").pop().toLowerCase())==-1&&""!=h&&f.push(c.Invalid_file_extension),d.options.maxFileSize>0&&a.size>1e6*d.options.maxFileSize&&f.push(c.Max_file_size_exceeded),f.length>0){var i=this;b('input[rel="'+b(a.previewTemplate).attr("rel")+'"]').remove();var j=b(a.previewTemplate).parent(".dropzone");i.removeFile(a),d.handlePostError(j,f),j.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){b(this).html("")}),g=-1,e("error")}else e()},sending:function(a,c,e){b(a.previewTemplate).attr("rel",(new Date).getTime()),e.append("timestamp",b(a.previewTemplate).attr("rel")),e.append("tag",b(d.$newmessageform).parent("div").attr("rel")),e.append("fileCount",b(d.$replyHolder).find('[name="attachments[]"]').length)},init:function(){b(this.element).data("dropzone",this)}}),b(d.$replyholder.find(".dropzone")).attr("data-dropzone-applied","true"),b.each(b(this),function(a,c){b(this).find(".ccm-conversation-attachment-container").each(function(){b(this).is(":visible")&&b(this).toggle()})})},attachmentDeleteTrigger:function(a){var d=a,e=b(this);return d.$attachmentdeletetdialog=d.$attachmentdeleteholder.clone(),d.$attachmentdeletetdialog.dialog?d.$attachmentdeletetdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:d.$attachmentdeletetdialog.attr("data-dialog-title"),buttons:[{text:d.$attachmentdeleteholder.attr("data-cancel-button-title"),class:"btn pull-left",click:function(){d.$attachmentdeletetdialog.dialog("close")}},{text:d.$attachmentdeleteholder.attr("data-confirm-button-title"),class:"btn pull-right btn-danger",click:function(){b(this).concreteConversationAttachments("deleteAttachment",{cnvMessageAttachmentID:e.attr("rel"),cnvObj:d,dialogObj:d.$attachmentdeletetdialog})}}]}):window.confirm(c.Confirm_remove_attachment)&&b(this).concreteConversationAttachments("deleteAttachment",{cnvMessageAttachmentID:e.attr("rel"),cnvObj:d,dialogObj:d.$attachmentdeletetdialog}),!1},clearDropzoneQueues:function(){b(".preview.processing").each(function(){b('input[rel="'+b(this).attr("rel")+'"]').remove()}),b("form.dropzone").each(function(){var a=b(this).data("dropzone");b.each(a.files,function(b,c){a.removeFile(c)})})},deleteAttachment:function(a){var d=a.cnvMessageAttachmentID,e=a.cnvObj,f=a.dialogObj,g=[{name:"cnvMessageAttachmentID",value:d}];b.ajax({type:"post",data:g,url:CCM_TOOLS_PATH+"/conversations/delete_file",success:function(a){var c=JSON.parse(a);b('p[rel="'+c.attachmentID+'"]').parent(".attachment-container").fadeOut(300,function(){b(this).remove()}),f.dialog&&(f.dialog("close"),e.publish("conversationDeleteAttachment",{cnvMessageAttachmentID:d}))},error:function(a){e.publish("conversationDeleteAttachmentError",{cnvMessageAttachmentID:d,error:arguments}),window.alert(c.Error_deleting_attachment)}})}};b.fn.concreteConversationAttachments=function(a){return d[a]?d[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?void b.error("Method "+a+" does not exist on concreteConversationAttachments"):d.init.apply(this,arguments)},b.fn.concreteConversationAttachments.localize=function(a){b.extend(!0,c,a)}}(window,jQuery);