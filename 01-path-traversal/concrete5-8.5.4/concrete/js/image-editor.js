!function(a,b){"use strict";Kinetic.Node.prototype.closest=function(a){for(var b=this.parent;void 0!==b;){if(b.nodeType===a)return b;b=b.parent}return!1},Kinetic.Stage.prototype.createCopy=function(){var a,b=[],c=this.getChildren();for(a=0;a<c.length;a++)b.push(c[a].clone());return b},Kinetic.Stage.prototype.getScaledWidth=function(){return Math.ceil(this.getWidth()/this.getScale().x)},Kinetic.Stage.prototype.getScaledHeight=function(){return Math.ceil(this.getHeight()/this.getScale().y)},Kinetic.Stage.prototype.getSaveWidth=function(){return this.im.saveWidth},Kinetic.Stage.prototype.getSaveHeight=function(){return this.im.saveHeight},Kinetic.Stage.prototype.getTotalDimensions=function(){var a=(this.getSaveHeight()/2-this.im.center.y)*this.getScale().y,b=a+this.getHeight()-this.getSaveHeight()*this.getScale().y,c=(this.getSaveWidth()/2-this.im.center.x)*this.getScale().x,d=c+this.getWidth()-this.getSaveWidth()*this.getScale().x;return{min:{x:c,y:a},max:{x:d,y:b},width:this.getScaledWidth(),height:this.getScaledHeight(),visibleWidth:Math.max(this.getSaveWidth(),2*this.getScaledWidth()-this.getSaveWidth()),visibleHeight:Math.max(this.getSaveHeight(),2*this.getScaledHeight()-this.getSaveHeight())}},Kinetic.Stage.prototype.loadCopy=function(a){var b;for(this.removeChildren(),b=0;b<a.length;b++)this.add(a[b]);this.draw()},Kinetic.Stage.prototype.elementType="stage",Kinetic.Image.prototype.getImageData=function(){var a=new Kinetic.Canvas(this.attrs.image.width,this.attrs.image.height),b=a.getContext();b.drawImage(this.attrs.image,0,0);try{var c=b.getImageData(0,0,a.getWidth(),a.getHeight());return c}catch(a){Kinetic.Util.warn("Unable to get imageData.")}},Kinetic.Layer.prototype._cacheddraw=(new Kinetic.Layer).draw,Kinetic.Layer.prototype.draw=function(){if("undefined"==typeof a.im||"undefined"==typeof a.im.trigger)return this._cacheddraw();var b=this._cacheddraw();return b},Kinetic.Layer.prototype.elementType="layer",Kinetic.Group.prototype.elementType="group",Kinetic.Text.prototype.rasterize=function(a){var b=this.parent,c=this;this.toImage({callback:function(d){var e=new Kinetic.Image({image:d,x:c.getPosition().x,y:c.getPosition().y});c.remove(),b.add(e).draw(),a.callback(e)}})},function(){var a,b;try{a=Object.getPrototypeOf(document.createElement("canvas").getContext("2d")),b=a.drawImage}catch(a){b=null}b&&(a.drawImage=function(){return arguments.length>=4&&(this.imageSmoothingEnabled=!0,"string"==typeof this.imageSmoothingQuality&&(this.imageSmoothingQuality="high")),b.apply(this,arguments)})}();var c=function(d){if(void 0===d)return this;d.pixelRatio=1;var e=this,f=function(a){return Math.round(a)};e.saveData=d.saveData||{},e.saveUrl=d.saveUrl,e.token=d.token,e.width=d.width,e.height=d.height,e.strictSize="undefined"!=typeof d.strictSize?!!d.strictSize:d.saveWidth>0,e.saveWidth=d.saveWidth||(e.strictSize?0:f(e.width/2)),e.saveHeight=d.saveHeight||(e.strictSize?0:f(e.height/2)),e.stage=new Kinetic.Stage(d),e.namespaces={},e.controlSets={},e.components={},e.settings=d,e.filters={},e.fileId=e.settings.fID,e.scale=1,e.crosshair=new Image,e.uniqid=e.stage.getContainer().id,e.editorContext=b(e.stage.getContainer()).parent(),e.domContext=e.editorContext.parent(),e.controlContext=e.domContext.children("div.controls"),e.controlSetNamespaces=[],e.showLoader=b.fn.dialog.showLoader,e.hideLoader=b.fn.dialog.hideLoader,e.stage.im=e,e.stage.elementType="stage",e.crosshair.src=CCM_IMAGE_PATH+"/image_editor/crosshair.png",e.center={x:Math.round(e.width/2),y:Math.round(e.height/2)},e.centerOffset={x:e.center.x,y:e.center.y};var g=function(a){return b(a,e.domContext)},h=function(){if(d.debug===!0&&"undefined"!=typeof window.console){var a=arguments;1==a.length&&(a=a[0]),window.console.log(a)}},i=function(){if(d.debug===!0&&"undefined"!=typeof window.console){var a=arguments;1==a.length&&(a=a[0]),window.console.warn(a)}},j=function(){if("undefined"!=typeof window.console){var a=arguments;1==a.length&&(a=a[0]),window.console.error("Image Editor Error: "+a)}};e.stage._setDraggable=e.stage.setDraggable,e.stage.setDraggable=function(a){return i("setting draggable to "+a),e.stage._setDraggable(a)},e.bindEvent=e.bind=e.on=function(a,c,d){var f=d||e.stage.getContainer();f instanceof b&&(f=f[0]),ConcreteEvent.sub(a,c,f)},e.fireEvent=e.fire=e.trigger=function(a,c,d){var f=d||e.stage.getContainer();f instanceof b&&(f=f[0]),ConcreteEvent.pub(a,c,f)},e.addElement=function(a,b){var c=new Kinetic.Layer;a.elementType=b,c.elementType=b,c.add(a),e.stage.add(c),c.moveDown(),e.stage.draw()},e.on("backgroundBuilt",function(){void 0!==e.activeElement&&void 0!==e.activeElement.doppelganger&&(e.foreground.add(e.activeElement.doppelganger),e.activeElement.doppelganger.setPosition(e.activeElement.getPosition()))}),e.setActiveElement=function(a){return a.defer?e.setActiveElement(a.defer):void(e.activeElement!=a&&(void 0!==e.activeElement&&void 0!==e.activeElement.doppelganger&&e.activeElement.doppelganger.remove(),a===e.stage||"Stage"==a.nodeType?(e.trigger("ChangeActiveAction",e.controlSetNamespaces.length?e.controlSetNamespaces[0]:void 0),b("div.control-sets",e.controlContext).find("h4.active").removeClass("active")):void 0!==a.doppelganger&&(e.foreground.add(a.doppelganger),e.foreground.draw()),e.trigger("beforeChangeActiveElement",e.activeElement),e.alterCore("activeElement",a),e.trigger("changeActiveElement",a),e.stage.draw()))},e.bind("ClickedElement",function(a,b){e.setActiveElement(b)}),e.bind("stageChanged",function(a){(e.activeElement.getWidth()>e.stage.getScaledWidth()||e.activeElement.getHeight()>e.stage.getScaledHeight())&&e.setActiveElement(e.stage)});var k=g(e.stage.getContainer()).parent().children(".bottomBar");k.attr("unselectable","on");var l={};l.zoomIn=g("<div class='bottombarbutton plus'><i class='fa fa-plus'></i></div>"),l.zoomOut=g("<div class='bottombarbutton'><i class='fa fa-minus'></i></div>"),l.zoomIn.appendTo(k),l.zoomOut.appendTo(k),l.zoomIn.click(function(a){e.fire("zoomInClick",a)}),l.zoomOut.click(function(a){e.fire("zoomOutClick",a)});var m=g("<div></div>").addClass("scale").text("100%");e.on("scaleChange",function(a){m.text(Math.round(1e4*e.scale)/100+"%")}),m.click(function(){e.scale=1,e.stage.setScale(e.scale);var a=e.stage.getDragBoundFunc()({x:e.stage.getX(),y:e.stage.getY()});e.stage.setX(a.x),e.stage.setY(a.y),e.fire("scaleChange"),e.buildBackground(),e.stage.draw()}),m.appendTo(k);var n=5/6;e.on("zoomInClick",function(a){var b=(-e.stage.getX()+e.stage.getWidth()/2)/e.scale,c=(-e.stage.getY()+e.stage.getHeight()/2)/e.scale;e.scale/=n,e.scale=Math.round(1e3*e.scale)/1e3,e.alterCore("scale",e.scale);var d=(-e.stage.getX()+e.stage.getWidth()/2)/e.scale,f=(-e.stage.getY()+e.stage.getHeight()/2)/e.scale;e.stage.setX(e.stage.getX()-(b-d)*e.scale),e.stage.setY(e.stage.getY()-(c-f)*e.scale),e.stage.setScale(e.scale);var g=e.stage.getDragBoundFunc()({x:e.stage.getX(),y:e.stage.getY()});e.stage.setX(g.x),e.stage.setY(g.y),e.fire("scaleChange"),e.buildBackground(),e.stage.draw()}),e.on("zoomOutClick",function(a){var b=(-e.stage.getX()+e.stage.getWidth()/2)/e.scale,c=(-e.stage.getY()+e.stage.getHeight()/2)/e.scale;e.scale*=n,e.scale=Math.round(1e3*e.scale)/1e3,e.alterCore("scale",e.scale);var d=(-e.stage.getX()+e.stage.getWidth()/2)/e.scale,f=(-e.stage.getY()+e.stage.getHeight()/2)/e.scale;e.stage.setX(e.stage.getX()-(b-d)*e.scale),e.stage.setY(e.stage.getY()-(c-f)*e.scale),e.stage.setScale(e.scale);var g=e.stage.getDragBoundFunc()({x:e.stage.getX(),y:e.stage.getY()});e.stage.setX(g.x),e.stage.setY(g.y),e.fire("scaleChange"),e.buildBackground(),e.stage.draw()});var o={};if(o.width=g("<span/>").addClass("saveWidth"),o.height=g("<span/>").addClass("saveHeight"),o.crop=g('<div><i class="icon-resize-full"/></div>').addClass("bottombarbutton").addClass("crop"),o.both=o.height.add(o.width).width(32).attr("contenteditable",!0),o.area=g("<span/>").css({float:"right"}),e.on("adjustedsavers",function(){o.width.text(e.saveWidth),o.height.text(e.saveHeight)}),o.crop.click(function(){e.adjustSavers()}),e.strictSize?o.both.attr("disabled","true"):o.both.keyup(function(a){e.fire("editedSize",a)}),e.bind("editedSize",function(a){e.saveWidth=parseInt(o.width.text()),e.saveHeight=parseInt(o.height.text()),isNaN(e.saveWidth)&&(e.saveWidth=0),isNaN(e.saveHeight)&&(e.saveHeight=0),e.buildBackground()}),e.bind("saveSizeChange",function(){o.width.text(e.saveWidth),o.height.text(e.saveHeight)}),e.setCursor=function(a){b(e.stage.getContainer()).css("cursor",a)},e.save=function(){e.fire("ChangeActiveAction"),e.fire("ImageEditorWillSave"),b.fn.dialog.showLoader(),e.stage.toDataURL({callback:function(a){var c=b("<img />").addClass("fake_canvas").appendTo(e.editorContext.children(".Editor"));c.attr("src",a),c.css({position:"absolute",top:0,left:0,backgroundColor:"white"});var f=e.stage.getPosition(),g=e.scale,h=e.stage.getWidth(),i=e.stage.getHeight();e.stage.setPosition(-e.saveArea.getX(),-e.saveArea.getY()),e.stage.setScale(1),e.background.hide(),e.foreground.hide(),e.stage.setHeight(e.saveHeight+100),e.stage.setWidth(e.saveWidth+100),e.stage.draw();var j=d.mime;"image/jpeg"!==j&&"image/png"!==j&&(j="image/png"),e.stage.toDataURL({mimeType:j,quality:d.jpegCompression,width:e.saveWidth,height:e.saveHeight,callback:function(a){e.stage.setPosition(f),e.background.show(),e.foreground.show(),e.stage.setScale(g),e.stage.setHeight(i),e.stage.setWidth(h),e.stage.draw(),c.remove(),b.post(e.saveUrl,_.extend(e.saveData,{fID:e.fileId,imgData:a,ccm_token:e.token}),function(c){b.fn.dialog.hideLoader();var d=JSON.parse(c);1===d.error?(window.alert(d.message),b("button.save[disabled]").attr("disabled",!1)):0===d.error&&(e.fire("ImageEditorDidSave",_.extend(e.saveData,{fID:e.fileId,imgData:a})),Concrete.event.fire("ImageEditorDidSave",_.extend(e.saveData,{fID:e.fileId,imgData:a})))})}})}})},e.actualPosition=function(a,b,c,d,f){var g=b-d,h=a-c,i=e.activeElement.getRotation()+Math.atan2(g,h),j=Math.sqrt(Math.pow(h,2)+Math.pow(g,2));return[c+j*Math.cos(i),d+j*Math.sin(i)]},e.getActualRect=function(a,b,c){var d=[],f=c.getRotation();return d.push(e.actualPosition(c.getX(),c.getY(),a,b,f)),d.push(e.actualPosition(c.getX()+c.getWidth()*c.getScaleX(),c.getY(),a,b,f)),d.push(e.actualPosition(c.getX()+c.getWidth()*c.getScaleX(),c.getY()+c.getHeight()*c.getScaleY(),a,b,f)),d.push(e.actualPosition(c.getX(),c.getY()+c.getHeight()*c.getScaleY(),a,b,f)),d},e.adjustSavers=function(a){if("Stage"!==e.activeElement.nodeType){e.foreground.autoCrop=!1,e.background.autoCrop=!1;var b,c,d={min:{x:!1,y:!1},max:{x:!1,y:!1}},f=e.activeElement,g=f.parent,h=e.getActualRect(0,0,f);for(b=h.length-1;b>=0;b--){var i=h[b],j=i[0]+g.getX(),k=i[1]+g.getY();(j>d.max.x||d.max.x===!1)&&(d.max.x=j),(j<d.min.x||d.min.x===!1)&&(d.min.x=j),(k>d.max.y||d.max.y===!1)&&(d.max.y=k),(k<d.min.y||d.min.y===!1)&&(d.min.y=k)}c={width:d.max.x-d.min.x,height:d.max.y-d.min.y},e.strictSize||(e.alterCore("saveWidth",Math.round(c.width)),e.alterCore("saveHeight",Math.round(c.height)),e.buildBackground());var l=[e.center.x-e.activeElement.getWidth()*e.activeElement.getScaleX()/2,e.center.y-e.activeElement.getHeight()*e.activeElement.getScaleY()/2],m=e.actualPosition(l[0],l[1],e.center.x,e.center.y,e.activeElement.getRotation());e.activeElement.parent.setPosition(m.map(Math.round)),a!==!1&&e.fire("adjustedsavers"),e.stage.draw()}},e.bind("imageLoad",function(){setTimeout(e.adjustSavers,0)}),e.extend=function(a,b){this[a]=b},e.alterCore=function(a,b){var c,d=e,f="core";e.namespace&&(f=d.namespace,d=e.realIm),e[a]=b;for(c in e.controlSets)e.controlSets[c].im.extend(a,b);for(c in e.filters)e.filters[c].im.extend(a,b);for(c in e.components)e.components[c].im.extend(a,b)},e.clone=function(a){var b,d=new c;d.realIm=e;for(b in e)d[b]=e[b];return d.namespace=a,d},e.addControlSet=function(a,c,d){b&&d instanceof b&&(d=d[0]),d.controlSet=function(c,e){c.disable=function(){c.enabled=!1,b(d).parent().parent().addClass("disabled")},c.enable=function(){c.enabled=!0,b(d).parent().parent().removeClass("disabled")},this.im=c,this.$=b,i("Loading ControlSet",c);try{new Function("im","$",e).call(this,c,b)}catch(b){window.console.log(b.stack);var f=b.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(f[1]&&!isNaN(parseInt(f[1]))){var g=e.split("\n"),h="Parse error at line #"+f[0]+" char #"+f[1]+" within "+a;h+="\n"+g[parseInt(f[0])-1],h+="\n"+new Array(parseInt(f[1])).join(" ")+"^",j(h)}else j('"'+b.message+'" in "'+c.namespace+'"')}return this};var f=e.clone(a),g=d.controlSet.call(d,f,c);return e.controlSets[a]=g,g},e.addFilter=function(a,c){var d=function(c,d){this.namespace=c.namespace,this.im=c;try{new Function("im","$",d).call(this,c,b)}catch(b){j(b),window.lastError=b;var e=b.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(2!=e.length)j(b.message),j(b.stack);else{var f=d.split("\n"),g="Parse error at line #"+e[0]+" char #"+e[1]+" within "+a;g+="\n"+f[parseInt(e[0])-1],g+="\n"+new Array(parseInt(e[1])||0).join(" ")+"^",j(g)}}return this},f=e.clone(a),g=new d(f,c);return e.filters[a]=g,g},e.addComponent=function(a,c,d){b&&d instanceof b&&(d=d[0]),d.component=function(c,d){c.disable=function(){b(this).parent().parent().addClass("disabled")},c.enable=function(){b(this).parent().parent().removeClass("disabled")},this.im=c,i("Loading component",c);try{new Function("im","$",d).call(this,c,b)}catch(b){var e=b.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(e[1]&&!isNaN(parseInt(e[1]))){var f=d.split("\n"),g="Parse error at line #"+e[0]+" char #"+e[1]+" within "+a;g+="\n"+f[parseInt(e[0])-1],g+="\n"+new Array(parseInt(e[1])).join(" ")+"^",j(g)}else j('"'+b.message+'" in "'+c.namespace+'"')}return this};var f=e.clone(a),g=d.component.call(d,f,c);return e.components[a]=g,g},e.background=new Kinetic.Layer,e.foreground=new Kinetic.Layer,e.stage.add(e.background),e.stage.add(e.foreground),e.bgimage=new Image,e.saveArea=new Kinetic.Rect,e.background.add(e.saveArea),e.bind("load",function(){e.saveArea.setFillPatternImage(e.bgimage),e.saveArea.setFillPatternOffset([-(e.saveWidth/2),-(e.saveHeight/2)]),e.saveArea.setFillPatternScale(1/e.scale),e.saveArea.setFillPatternX(0),e.saveArea.setFillPatternY(0),e.saveArea.setFillPatternRepeat("repeat"),e.background.on("click",function(){e.setActiveElement(e.stage)})},e.bgimage),e.bgimage.src=CCM_REL+"/concrete/images/testbg.png",e.buildBackground=function(){var a=e.stage.getTotalDimensions();e.saveArea.setFillPatternOffset([-(e.saveWidth/2)*e.scale,-(e.saveHeight/2)*e.scale]),e.saveArea.setX(Math.round(e.center.x-e.saveWidth/2)),e.saveArea.setY(Math.round(e.center.y-e.saveHeight/2)),e.saveArea.setFillPatternScale(1/e.scale),e.saveArea.setWidth(e.saveWidth),e.saveArea.setHeight(e.saveHeight),e.coverLayer||(e.coverLayer=new Kinetic.Rect,e.coverLayer.setStroke("rgba(150,150,150,.5)"),e.coverLayer.setFill("transparent"),e.coverLayer.setListening(!1),e.coverLayer.setStrokeWidth(Math.max(a.width,a.height,500)),e.foreground.add(e.coverLayer));var b=2*Math.max(a.width,a.height);e.coverLayer.setPosition(e.saveArea.getX()-b/2,e.saveArea.getY()-b/2),e.coverLayer.setSize(e.saveArea.getWidth()+b,e.saveArea.getHeight()+b),e.coverLayer.setStrokeWidth(b),e.fire("backgroundBuilt"),e.saveArea.draw(),e.coverLayer.draw()},e.buildBackground(),e.on("stageChanged",e.buildBackground),e.stage.setDragBoundFunc(function(a){var b=e.stage.getTotalDimensions(),c=Math.max(b.max.x,b.min.x)+100,d=Math.min(b.max.x,b.min.x)-100,f=Math.max(b.max.y,b.min.y)+100,g=Math.min(b.max.y,b.min.y)-100;return a.x=Math.floor(a.x),a.y=Math.floor(a.y),a.x>c&&(a.x=c),a.x<d&&(a.x=d),a.y>f&&(a.y=f),a.y<g&&(a.y=g),a.x=Math.floor(a.x),a.y=Math.floor(a.y),a}),e.setActiveElement(e.stage),e.stage.setDraggable(!0),e.autoCrop=!0,e.on("imageLoad",function(){var a=50,b=e.stage.getWidth()-2*a,c=e.stage.getHeight()-2*a;if(!(e.saveWidth<b&&e.saveHeight<c)){var d=Math.max(e.saveWidth/b,e.saveHeight/c);e.scale=1/d,e.scale=Math.round(100*e.scale)/100,e.alterCore("scale",e.scale),e.stage.setScale(e.scale),e.stage.setX((e.stage.getWidth()-e.stage.getWidth()*e.stage.getScale().x)/2),e.stage.setY((e.stage.getHeight()-e.stage.getHeight()*e.stage.getScale().y)/2);var f=e.stage.getDragBoundFunc()({x:e.stage.getX(),y:e.stage.getY()});e.stage.setX(f.x),e.stage.setY(f.y),e.fire("scaleChange"),e.fire("stageChanged"),e.buildBackground()}}),e.fit=function(a,b){if(b===!1)return{width:e.saveWidth,height:e.saveHeight};var c=a.height,d=a.width;return d>e.saveWidth&&(c/=d/e.saveWidth,d=e.saveWidth),c>e.saveHeight&&(d/=c/e.saveHeight,c=e.saveHeight),{width:d,height:c}},d.src){e.showLoader(ccmi18n_imageeditor.loadingImage);var p=new Image,q=!1;if(e.bind("ControlSetsLoaded",function(){q=!0}),e.bind("load",function(){function a(){_.defer(function(){e.stage.draw(),e.setActiveElement(c),e.fire("changeActiveAction",e.controlSetNamespaces[0])})}e.strictSize?0!=e.saveWidth&&0!=e.saveHeight||(0==e.saveWidth?0==e.saveHeight?(e.saveWidth=p.width,e.saveHeight=p.height,e.fire("saveSizeChange"),e.buildBackground()):(e.saveWidth=Math.floor(p.width/p.height*e.saveHeight),e.fire("saveSizeChange"),e.buildBackground()):0==e.saveHeight&&(e.saveHeight=Math.floor(p.height/p.width*e.saveWidth),e.fire("saveSizeChange"),e.buildBackground())):(e.saveWidth=p.width,e.saveHeight=p.height,e.fire("saveSizeChange"),e.buildBackground());var b={x:Math.floor(e.center.x-p.width/2),y:Math.floor(e.center.y-p.height/2)},c=new Kinetic.Image({image:p,x:0,y:0});c.setPosition(b),e.addElement(c,"image"),_.defer(function(){e.fire("imageload")}),q?a():e.bind("ControlSetsLoaded",a)},p),"crossOrigin"in d){var r=d.crossOrigin.toString().toLowerCase();p.crossOrigin=r}p.src=d.src}else e.fire("imageload");return e.bind("imageload",function(){var a,c=d.controlsets||{},f=0;h("Loading ControlSets"),e.showLoader(ccmi18n_imageeditor.loadingControlSets),e.fire("LoadingControlSets");for(a in c){var g="ControlSet_"+a;e.controlSetNamespaces.push(g),b.ajax(c[a].src,{dataType:"text",cache:!1,namespace:a,myns:g,beforeSend:function(){f++},success:function(a){f--;var b=e.addControlSet(this.myns,a,c[this.namespace].element);h(b),e.fire("controlSetLoad",b),0==f&&e.trigger("ControlSetsLoaded")},error:function(a,b,c){f--,0==f&&e.trigger("ControlSetsLoaded")}})}}),e.bind("ControlSetsLoaded",function(){e.fire("LoadingComponents"),e.showLoader(ccmi18n_imageeditor.loadingComponents);var a,c=d.components||{},f=0;h("Loading Components");for(a in c){var g="Component_"+a;b.ajax(c[a].src,{dataType:"text",cache:!1,namespace:a,myns:g,beforeSend:function(){f++},success:function(a){f--;var b=e.addComponent(this.myns,a,c[this.namespace].element);h(b),e.fire("ComponentLoad",b),0==f&&e.trigger("ComponentsLoaded")},error:function(a,b,c){f--,0==f&&e.trigger("ComponentsLoaded")}})}0==f&&e.trigger("ComponentsLoaded")}),e.bind("ComponentsLoaded",function(){h("Loading Filters"),e.showLoader(ccmi18n_imageeditor.loadingFilters);var a,c,f=d.filters||{},g=0;e.fire("LoadingFilters");for(a in f)f.hasOwnProperty(a)&&!function(a){var d=_.clone(f[a]),h="Filter_"+a,i=d.name;c||(c=h),g++,b.ajax(f[a].src,{dataType:"text",cache:!1,namespace:a,myns:h,name:i,success:function(a){var b=e.addFilter(this.myns,a);b.name=this.name,b.settings=d,e.fire("filterLoad",b),g--,0===g&&e.trigger("FiltersLoaded")},error:function(a,b,c){g--,0===g&&e.trigger("FiltersLoaded")}})}(a)}),e.bind("ChangeActiveAction",function(a,c){if(c!==e.activeControlSet){for(var d in e.controlSets)g(e.controlSets[d]),d!==c&&g(e.controlSets[d]).slideUp();if(e.activeControlSet=c,e.alterCore("activeControlSet",c),!c)return void b("div.control-sets",e.controlContext).find("h4.active").removeClass("active");var f=b(e.controlSets[c]),h=f.show().height();0!=f.length&&f.hide().height(h).slideDown(function(){b(this).height("")})}}),e.bind("ChangeActiveComponent",function(a,c){if(c!==e.activeComponent){for(var d in e.components)d!==c&&g(e.components[d]).slideUp();if(e.activeComponent=c,e.alterCore("activeComponent",c),c){var f=b(e.components[c]),h=f.show().height();0!=f.length&&f.hide().height(h).slideDown(function(){b(this).height("")})}}}),e.bind("ChangeNavTab",function(a,b){e.trigger("ChangeActiveAction",b),e.trigger("ChangeActiveComponent",b);var c=g("div.editorcontrols");switch(b){case"add":c.children("div.control-sets").hide(),c.children("div.components").show();break;case"edit":c.children("div.components").hide(),c.children("div.control-sets").show()}}),e.bind("FiltersLoaded",function(){e.hideLoader()}),e.slideOut=b("<div/>").addClass("slideOut").css({width:0,float:"right",height:"100%","overflow-x":"hidden",right:e.controlContext.width()-1,position:"absolute",background:"white","box-shadow":"black -20px 0 20px -25px"}),e.slideOutContents=b("<div/>").appendTo(e.slideOut).width(300),e.showSlideOut=function(a,b){e.hideSlideOut(function(){e.slideOut.empty(),e.slideOutContents=a.width(300),e.slideOut.append(e.slideOutContents),e.slideOut.addClass("active").addClass("sliding"),e.slideOut.stop(1).slideOut(300,function(){e.slideOut.removeClass("sliding"),"function"==typeof b&&b()})})},e.hideSlideOut=function(a){e.slideOut.addClass("sliding"),e.slideOut.slideIn(300,function(){e.slideOut.css("border-right","0"),e.slideOut.removeClass("active").removeClass("sliding"),"function"==typeof a&&a()})},e.controlContext.after(e.slideOut),e.setActiveElement(e.stage),a.c5_image_editor=e,a.im=e,e};b.fn.ImageEditor=function(a){void 0===a&&(a={}),a.imageload=b.fn.dialog.hideLoader;var d=b(this);if(a.container=d[0],0==d.height())return void setTimeout(function(){d.ImageEditor(a)},50);d.closest(".ui-dialog").find(".ui-resizable-handle").hide(),d.height("-=30"),b("div.editorcontrols").height(d.height()-90),d.width("-=330").parent().width("-=330").children("div.bottomBar").width("-=330"),void 0===a.width&&(a.width=d.width()),void 0===a.height&&(a.height=d.height()),b.fn.dialog.showLoader();var e=new c(a),f=e.domContext;return b("div.control-sets > div.controlset",f).each(function(){var a=b(this),c=a.data("namespace");a.find("h4").click(function(){a.hasClass("active")||e.fire("ChangeActiveAction","ControlSet_"+c)}),e.bind("ChangeActiveAction",function(b,d){if(d==="ControlSet_"+c){f.find("div.controlset.active").removeClass("active").children(".control").slideUp(250),a.addClass("active");var e=a.children(".control").height("auto");e.slideDown(250)}})}),b("div.controls > div.controlscontainer",f).children("div.save").children("button.save").click(function(){b(this).attr("disabled",!0),e.save()}).end().children("button.cancel").click(function(){window.confirm(ccmi18n_imageeditor.areYouSure)&&b.fn.dialog.closeTop()}),e.on("ChangeActiveAction",function(a,c){c||b("h4.active",f).removeClass("active")}),e.on("ChangeActiveComponent",function(a,c){c||b("div.controlset.active",f).removeClass("active")}),e.bind("imageload",b.fn.dialog.hideLoader),e},b.fn.slideOut=function(a,c){var d=b(this),e=d.width(),f=255;return d.css("overflow-y","auto"),e==f?(d.animate({width:f},0,c),this):(d.width(e).animate({width:f},a||300,c||function(){}),this)},b.fn.slideIn=function(a,c){var d=b(this);return d.css("overflow-y","hidden"),0===d.width()?(d.animate({width:0},0,c),this):(d.animate({width:0},a||300,c||function(){}),this)},c.prototype=c.fn={filter:{grayscale:Kinetic.Filters.Grayscale,sepia:function(a){var b,c=a.data;for(b=0;b<c.length;b+=4)c[b]=.393*c[b]+.769*c[b+1]+.189*c[b+2],c[b+1]=.349*c[b]+.686*c[b+1]+.168*c[b+2],c[b+2]=.272*c[b]+.534*c[b+1]+.131*c[b+2]},brightness:function(a,b){for(var c=b.level,d=a.data,e=0;e<d.length;e+=4)d[e]+=c,d[e+1]+=c,d[e+2]+=c},invert:function(a,b){for(var c=a.data,d=0;d<c.length;d+=4)c[d]=255-c[d],c[d+1]=255-c[d+1],c[d+2]=255-c[d+2]},restore:function(a,b){for(var c=a.data,d=b.imageData.data,e=0;e<c.length;e+=4)c[e]=d[e],c[e+1]=d[e+1],c[e+2]=d[e+2]}}},a.ImageEditor=c}(window,jQuery);