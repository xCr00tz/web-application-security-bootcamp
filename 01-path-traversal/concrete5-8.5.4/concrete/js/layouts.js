!function(a,b){"use strict";jQuery.fn.concreteLayout=function(a){return this.each(function(){var d=b(this),e=d.data("concreteLayout");e||d.data("concreteLayout",e=new c(this,a))})};var c=function(a,c){this.options=b.extend({toolbar:"#ccm-layouts-toolbar",btnsave:"#ccm-layouts-save-button",btncancel:"#ccm-layouts-cancel-button",editing:!1,supportsgrid:!1,gridrowtmpid:"ccm-theme-grid-temp",additionalGridColumnClasses:""},c),this.$element=b(a),this.$toolbar=b(this.options.toolbar),this._setupDOM(),this._setupToolbarView(),this._setupFormSaveAndCancel(),this._setupFormEvents(),this._updateChooseTypeForm()};c.prototype._setupDOM=function(){this.$formviews=this.$toolbar.find("li[data-grid-form-view]"),this.$formviewcustom=this.$toolbar.find("li[data-grid-form-view=custom]"),this.$formviewthemegrid=this.$toolbar.find("li[data-grid-form-view=themegrid]"),this.$selectgridtype=this.$toolbar.find("select[name=gridType]"),this.$selectcolumnscustom=this.$toolbar.find("input[type=text][name=columns]"),this.$customspacing=this.$toolbar.find("input[name=spacing]"),this.$customautomatedfrm=this.$toolbar.find("input[name=isautomated]"),this.$customautomated=this.$toolbar.find("[data-layout-button=toggleautomated]"),this.$selectgridcolumns=this.$toolbar.find("input[type=text][name=themeGridColumns]"),this.$savebtn=this.$toolbar.find(this.options.btnsave),this.$cancelbtn=this.$toolbar.find(this.options.btncancel),this.$slider=!1},c.prototype._setupFormSaveAndCancel=function(){var a=this;this.$cancelbtn.unbind().on("click",function(){a.$toolbar.remove(),ConcreteEvent.unsubscribe("EditModeExitInlineComplete.layouts"),ConcreteEvent.on("EditModeExitInlineComplete.layouts",function(b,c){a._rescanAreasInPage(b,c)}),ConcreteEvent.fire("EditModeExitInline")}),this.$savebtn.unbind().on("click",function(){Concrete.event.fire("EditModeExitInlineSaved"),a.$toolbar.hide().prependTo("#ccm-block-form"),b("#ccm-block-form").submit(),ConcreteEvent.unsubscribe("EditModeExitInlineComplete.layouts"),ConcreteEvent.on("EditModeExitInlineComplete.layouts",function(b,c){a._rescanAreasInPage(b,c)})})},c.prototype._rescanAreasInPage=function(a,b){var c=Concrete.getEditMode();c.reset(),c.scanBlocks()},c.prototype._setupToolbarView=function(){var a=this;this.$formviews.each(function(c){b(this).attr("data-grid-form-view")!=a.options.formview&&b(this).hide()})},c.prototype._updateChooseTypeForm=function(){var a=this.$selectgridtype.find("option:selected").val(),c=this;switch(c.options.editing&&c.$selectgridtype.prop("disabled",!0),a){case"FF":this.$formviewthemegrid.hide(),this.$formviewcustom.show(),this._updateCustomView();break;case"TG":this.$formviewcustom.hide(),this.$formviewthemegrid.show(),this._updateThemeGridView();break;default:if(this.options.editing)return;var d=a;this._resetSlider(),jQuery.fn.dialog.showLoader();var e=CCM_DISPATCHER_FILENAME+"/ccm/system/dialogs/area/layout/presets/get/"+CCM_CID+"/"+d;b.getJSON(e,function(a){c.$formviewthemegrid.hide(),c.$formviewcustom.hide(),c.$element.html(a.html),c.$element.append(b("<input />",{name:"arLayoutPresetID",type:"hidden",value:d})),jQuery.fn.dialog.hideLoader()})}},c.prototype._setupFormEvents=function(){var a=this;this.$selectcolumnscustom.on("keyup",function(){a._updateCustomView()}),this.$customspacing.on("keyup",function(){a._updateCustomView()}),this.$customautomatedfrm.on("change",function(){a._updateCustomView()}),this.$customautomated.on("click",function(){return b(this).parent().hasClass("ccm-inline-toolbar-icon-selected")?(b(this).parent().removeClass("ccm-inline-toolbar-icon-selected"),a.$customautomatedfrm.val(0)):(b(this).parent().addClass("ccm-inline-toolbar-icon-selected"),a.$customautomatedfrm.val(1)),a.$customautomatedfrm.trigger("change"),!1}),this.$selectgridcolumns.on("keyup",function(){a._updateThemeGridView()}),this.$selectgridtype.on("change",function(){a._updateChooseTypeForm()})},c.prototype.buildThemeGridGrid=function(){this.$element.html("");var a=this.options.rowstart;a+='<div id="ccm-theme-grid-edit-mode-row-wrapper">';var c=this._getThemeGridColumnSpan(this.columns);b.each(c,function(b,c){var d='<div id="ccm-edit-layout-column-'+b+'" class="'+c.cssClass+' ccm-theme-grid-column" data-offset="0" data-span="'+c.value+'"><div class="ccm-layout-column-highlight"><input type="hidden" id="ccm-edit-layout-column-offset-'+b+'" name="offset['+b+']" value="0" /><input type="hidden" id="ccm-edit-layout-column-span-'+b+'" name="span['+b+']" value="'+c.value+'" /></div></div>';a+=d}),a+="</div>",a+=this.options.rowend,this.$element.append(a)},c.prototype._updateThemeGridView=function(a){a||this.$selectgridtype.find("option[value=TG]").prop("selected",!0),this.columns=parseInt(this.$selectgridcolumns.val()),this.maxcolumns=parseInt(this.$selectgridcolumns.attr("data-maximum")),this.options.editing?this.$selectgridcolumns.prop("disabled",!0):this.buildThemeGridGrid(),this._resetSlider(),this.columns>1&&this._showThemeGridSlider()},c.prototype._buildThemeGridGridFromPresetColumns=function(a){this.$element.html("");var c=this.options.rowstart;c+='<div id="ccm-theme-grid-edit-mode-row-wrapper">',b.each(a,function(a,b){var d='<div id="ccm-edit-layout-column-'+a+'" class="ccm-theme-grid-column" data-offset="'+b.arLayoutColumnOffset+'" data-span="'+b.arLayoutColumnSpan+'"><div class="ccm-layout-column-highlight"><input type="hidden" id="ccm-edit-layout-column-offset-'+a+'" name="offset['+a+']" value="'+b.arLayoutColumnOffset+'" /><input type="hidden" id="ccm-edit-layout-column-span-'+a+'" name="span['+a+']" value="'+b.arLayoutColumnSpan+'" /></div></div>';c+=d}),c+="</div>",c+=this.options.rowend,this.$element.append(c),this.columns=a.length,this.maxcolumns=parseInt(this.$selectgridcolumns.attr("data-maximum")),this._resetSlider(),this._redrawThemeGrid(),this._showThemeGridSlider()},c.prototype._updateCustomView=function(a){a||this.$selectgridtype.find("option[value=FF]").prop("selected",!0),this.columns=parseInt(this.$selectcolumnscustom.val()),this.customspacing=this.$customspacing.val(),this.automatedcustomlayout=1==this.$customautomatedfrm.val(),this.columnwidths=[],this.options.editing&&this.$selectcolumnscustom.prop("disabled",!0),this.options.editing||this.$element.html("");var c,d,e;for(e=0;e<this.columns;e++)this.options.editing&&b("#ccm-edit-layout-column-"+e).length>0||(d=b("<div />").attr("class","ccm-layout-column"),d.attr("id","ccm-edit-layout-column-"+e),c=b("<div />").attr("class","ccm-layout-column-highlight"),c.append(b("<input />",{name:"width["+e+"]",type:"hidden",id:"ccm-edit-layout-column-width-"+e})),d.append(c),this.$element.append(d));var f=this.$element.find(".ccm-layout-column");if(this.columns<f.length)for(e=this.columns;e<f.length;e++)b("#ccm-edit-layout-column-"+e).remove();for(e=0;e<this.columns;e++){c=b("#ccm-edit-layout-column-"+e+" .ccm-layout-column-highlight"),e>0&&c.css("margin-left",this.customspacing/2+"px"),e+1<this.columns&&c.css("margin-right",this.customspacing/2+"px"),d=b("#ccm-edit-layout-column-"+e);var g;d.attr("data-width")?(g=d.attr("data-width")+"px",this.columnwidths.push(parseInt(d.attr("data-width")))):g=100/this.columns+"%",d.css("width",g)}this._resetSlider(),!this.automatedcustomlayout&&this.columns>1&&this._showCustomSlider()},c.prototype._resetSlider=function(){this.$slider&&(this.$slider.slider("destroy"),this.$slider=!1),b("#ccm-area-layout-active-control-bar").hasClass("ccm-area-layout-control-bar-add")&&b("#ccm-area-layout-active-control-bar").css("height","0px")},c.prototype._getThemeGridColumnSpan=function(a){var b,c=Math.ceil(this.maxcolumns/a),d=[];for(b=0;b<a;b++)d[b]=c;var e=c*a;for(b=0;b<e-this.maxcolumns;b++){var f=d.length-b-1;d[f]--}var g=[];for(b=0;b<d.length;b++)g[b]={},g[b].cssClass=this.options.gridColumnClasses[d[b]-1],this.options.additionalGridColumnClasses&&(g[b].cssClass=g[b].cssClass+" "+this.options.additionalGridColumnClasses),g[b].value=d[b];return g},c.prototype._getThemeGridNearestValue=function(a,c){var d=null;return b.each(c,function(){(null==d||Math.abs(this-a)<Math.abs(d-a))&&(d=this)}),d},c.prototype._showThemeGridSlider=function(){var a=this;a.$slider=b("#ccm-area-layout-active-control-bar"),a.$slider.css("height","6px");var c,d=[];for(o=0;o<a.columns;o++)c=b("#ccm-edit-layout-column-"+o),0==o?d.push(Math.floor(c.width())):o+1==a.columns?d.push(Math.floor(c.position().left)):(d.push(Math.floor(c.position().left)),d.push(Math.floor(c.width())+Math.floor(c.position().left)));var e=b("#ccm-area-layout-active-control-bar").width(),f=[],g=[],h=a.options.maxcolumns,i=a.options.gridColumnClasses[0],j=b("#ccm-theme-grid-edit-mode-row-wrapper").closest(".ccm-block-edit-layout, .ccm-layouts-edit-mode-add");j.length||(j=b("#ccm-theme-grid-edit-mode-row-wrapper"));var k=b("<div />",{id:a.options.gridrowtmpid}).appendTo(j),l="";for(o=1;o<=h;o++)l+=a.options.additionalGridColumnClasses?'<div class="'+i+" "+a.options.additionalGridColumnClasses+'"><br><br></div>':'<div class="'+i+'"><br><br></div>';var m=a.options.rowstart+l+a.options.rowend;k.append(b(m));for(var n=0,o=0;o<h;o++){if(c=k.find("."+i).eq(o),0==o){var p=c.position().left;p<0&&(n=Math.abs(p))}f.push(Math.floor(c.position().left+n)),g.push(Math.floor(Math.floor(c.width())+Math.floor(c.position().left)+n))}k.remove(),a.$slider.slider({min:0,max:e,step:1,values:d,slide:function(c,e){"TG"!=a.$selectgridtype.val()&&a.$selectgridtype.find("option[value=TG]").prop("selected",!0);var h,i=b(e.handle).index();h=i%2==0?g:f;for(var j=0;j<d.length;j++)for(var k=0;k<h.length;k++){var l=Math.abs(d[j]-h[k]);l<=2&&(h[k]=d[j])}var m=a.$slider.slider("values",i),n=a._getThemeGridNearestValue(e.value,h),o=!0;if(b.each(e.values,function(a,b){n>=b&&i<a?o=!1:n<=b&&i>a&&(o=!1)}),o&&m==n&&(o=!1),o){a.$slider.slider("values",i,n);var p,q,r,s,t;i%2==0?(s=Math.floor(i/2),t=b("#ccm-edit-layout-column-"+s),p=parseInt(t.attr("data-span")),q=t.nextAll(".ccm-theme-grid-column:first"),r=q.attr("data-offset"),r=r?parseInt(r):0,n>m?(p++,r--):(p--,r++)):(s=Math.ceil(i/2),t=b("#ccm-edit-layout-column-"+s),p=parseInt(t.attr("data-span")),q=t,r=q.attr("data-offset"),r=r?parseInt(r):0,n<m?(p++,r--):(p--,r++)),q.attr("data-offset",r),t.attr("data-span",p),a._redrawThemeGrid()}return!1}})},c.prototype._redrawThemeGrid=function(){var a=this;a.$element.find(".ccm-theme-grid-offset-column").remove(),b.each(a.$element.find(".ccm-theme-grid-column"),function(c,d){var e=b(d);if(e.removeClass(),e.attr("data-span")){var f=parseInt(e.attr("data-span"))-1;e.addClass(a.options.gridColumnClasses[f]),a.options.additionalGridColumnClasses&&e.addClass(a.options.additionalGridColumnClasses)}if(parseInt(e.attr("data-offset"))>0){var g=parseInt(e.attr("data-offset"))-1,h=a.options.gridColumnClasses[g]+" ccm-theme-grid-offset-column";a.options.additionalGridColumnOffsetClasses&&(h=h+" "+a.options.additionalGridColumnOffsetClasses),b("<div />",{"data-offset-column":!0}).html("&nbsp;").addClass(h).insertBefore(e)}b("#ccm-edit-layout-column-offset-"+c).val(parseInt(e.attr("data-offset"))),b("#ccm-edit-layout-column-span-"+c).val(parseInt(e.attr("data-span"))),e.addClass("ccm-theme-grid-column"),a.options.editing&&e.addClass("ccm-theme-grid-column-edit-mode")})},c.prototype._showCustomSlider=function(){this.$slider=b("#ccm-area-layout-active-control-bar"),this.$slider.css("height","6px");var a,c=[],d=0,e=Math.floor(this.$slider.width()),f=this.$element.find(".ccm-layout-column");if(this.columnwidths.length>0)for(a=0;a<this.columnwidths.length-1;a++)d+=this.columnwidths[a],c.push(d);else{var g=e/this.columns;for(a=1;a<this.columns;a++)d+=g,c.push(d)}var h=this;this.$slider.slider({min:0,max:e,step:1,values:c,create:function(a,d){var g=0;b.each(f,function(a,d){var h,i=c[a];h=a+1==f.length?e-g:i-g,h=Math.floor(h),b(d).find("#ccm-edit-layout-column-width-"+a).val(h),g=i})},slide:function(a,c){"FF"!=h.$selectgridtype.val()&&h.$selectgridtype.find("option[value=FF]").prop("selected",!0);var d=0,g=!0;return b.each(c.values,function(a,b){b<d&&(g=!1),d=b}),!!g&&(d=0,void b.each(f,function(a,g){var h;h=a+1==f.length?e-d:c.values[a]-d,h=Math.floor(h),b(g).find("#ccm-edit-layout-column-width-"+a).val(h),b(g).css("width",h+"px"),d=c.values[a]}))}})}}(this,jQuery);